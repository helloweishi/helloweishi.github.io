<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Wei</title>
    <description>Welcome to Wei's blog.</description>
    <link>https://github.com/helloweishi//</link>
    <atom:link href="https://github.com/helloweishi//feed.xml" rel="self" type="application/rss+xml" />
    
      <item>
        <title>Visit youtube inside firewall without VPN</title>
        <description>&lt;p&gt;This article I like to introduce some technical details about how firewall system block Youtube service, and based on the analysis of filter mechanism, I will try to tell you how to break it.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Here we go.&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;In last article, I tried to analysis how firewall system block Google, which is &lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;p&gt;IP address filtering&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;keywords filtering&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;these two mechanism also work here, but there are a little difference in keywords filtering, when you visit Google&amp;rsquo;s search service, firewall system check GET/POST packets for your search keywords, it will trigger firewall system send RST packet to your device if some sensitive information found, for Youtube, firewall system still check GET/POST packets, but different header field in HTTP header, which is HOST, this header field is required in every HTTP request packets, its value is target&amp;rsquo;s domain name, firewall system can known which domain name you want to visit by checking this field-value, here it is youtube.com, so it will trigger firewall system send RST to your device.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Filtering Summarize&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;The youtube service block mechanism: the first step is add youtube severs&amp;rsquo; IP addresses into black list, the second step is check HOST header field in HTTP header, which HTTP packet type is GET/POST, if it is youtube.com, fire RST.&lt;/p&gt;

&lt;p&gt;there is one question here, if you find a valid youtube server&amp;rsquo;s IP address, which is not in black list, and you input that IP address in browser, it doesn&amp;rsquo;t return youtube&amp;rsquo;s website to you, but Google&amp;rsquo;s search website. You know, Google has many services, youtube is one of them, that means Google&amp;rsquo;s IP pool is youtube&amp;rsquo;s IP pool, too, and it has Gmail, maps, docs, and etc, almost all of these services you can visit from the same server, actually, I don&amp;rsquo;t know how Google works, and it is not very possible that Google have all the services in the same server, I guess it must have some internal mechanism between Google servers, they can schedule other resources from other servers when they don&amp;rsquo;t have, and return to user directly, and don&amp;rsquo;t need user to visit other servers, this can simplify the procedure. In last article, I said when you found a valid Google server&amp;rsquo;s IP address, and just input that address in browser, Google will return you a search website, which is its default service, how we can visit Google other services from the same server ? from my investigation, this service discrimination lie in header field HOST of HTTP header, that is why firewall system use it to block youtube service, when you just input Google server&amp;rsquo;s IP address in browser, HOST is the IP address you input, Google don&amp;rsquo;t know which service you want to access, so it return its default service&amp;mdash;-search engine, if you visit its youtube service, HOST field-value is youtube.com, if Gmail, HOST field-value is gmail.google.com, if maps, HOST field-value is maps.google.com, and etc. &lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/hostHeaderField.png&quot; alt=&quot;Host Header field&quot;&gt;
&lt;center&gt;&lt;small&gt;Figure 1: Host Header Field snapshot&lt;/small&gt;&lt;/center&gt;  &lt;/p&gt;

&lt;p&gt;you may ask how to make HOST field-value be the target service domain in HTTP header, or how to relate the target service domain with the IP address you specified? In order to answer this question, let&amp;rsquo;s talk about what exactly happens when you input a URL in browser.&lt;/p&gt;

&lt;p&gt;The first thing operator system want to know is where you want to visit, it decode what you input, if it is a IP address, operator system will establish a connection with server with that IP address, and get what you request; if it is domain name, operator system need to translate domain name into IP address, and then, establish a connection, get what you request.
how operator system translate domain name into IP address is very import part of this article, so I talk about it in detail, each OS, like windows, Linux, may have a little difference, but the main idea is the same, let&amp;rsquo;s first talk about Linux, Ubuntu, as a example, when it receive a domain name, where it first send DNS query to depends on the configure file /etc/resolv.conf, by default, the target DNS server is 127.0.0.1, that means it send DNS query to itself, Ubuntu handle DNS in proxy way, one dnsmasq process listens on port 53, which port is reserved for DNS, after dnsmasq receives DNS query, what it first do is check configuration file /etc/hosts, if there is a domain name in this file match domain in DNS query, it will return IP address configured for that domain directly, and no DNS query will send out, if no match, dnsmsq will send DNS query to DNS server configured on default WAN interface, when DNS response receives, it will return to application which is waiting, here it is browser, if no DNS response receives, dnsmasq will try several times till time out.&lt;/p&gt;

&lt;p&gt;Windows has a similar mechanism and similar hosts configuration file, it is C:\windows\system32\driver\etc\hosts. You know, for all the forbidden sites in firewall system, the most important thing is &lt;big&gt;avoid send any DNS query out, any IP addresses return from DNS servers inside firewall system are in black list&lt;/big&gt;.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Time To Break Restriction&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;Break restriction 1:
For IP address blocking, in previous article, I already said how to find a valid IP address, skip it here.&lt;/p&gt;

&lt;p&gt;Break restriction 2:
after find a valid IP address, we can&amp;rsquo;t input it in browser directly, because Google won&amp;rsquo;t know which service you want to visit, need to do a little trick, configure IP address of domain youtube.com into hosts file,
like appending below to host file in your OS:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;(replace here with ip you find)            youtube.com ytimg.com google.com google.com.hk googlevideo.com&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;it works at windows OS, but Linux, that is because there is a little different when they search domain in hosts file, windows OS search domain&amp;rsquo;s suffix, if you configure google.com in hosts file, the target service domains all with suffix google.com, like maps.google.com, docs.google.com, can match in host file, and return IP address succeed, but Linux, it is strict match, that means google.com only match google.com, if the target service domain is maps.google.com, Linux will failed to find a entry in hosts file, that is weird, but it is not so difficult problem, change the match rule in dnsmasq, just several lines of code can fix it, and I will come up later when it is done. Without match rule change in dnsmasq, you still can open youtube site, but when you watch video, it will display error, that is because video&amp;rsquo;s service domain name is not a fixed one, but with some weird prefix, like r2&amp;mdash;xxxx.googlevideo.com, r4&amp;mdash;xxxx.googlevideo.com, so match rule in dnsmasq has to be changed before watching video.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/youtube1.png&quot; alt=&quot;youtube snapshot 1&quot;&gt;
&lt;center&gt;&lt;small&gt;Figure 2: youtube site snapshot&lt;/small&gt;&lt;/center&gt;&lt;br&gt;
&lt;img src=&quot;/images/youtube2.png&quot; alt=&quot;youtube snapshot 2&quot;&gt;
&lt;center&gt;&lt;small&gt;Figure 3: youtube site snapshot 2&lt;/small&gt;&lt;/center&gt;  &lt;/p&gt;

&lt;p&gt;And about keywords filter system in firewall, I think we have a way to ignore the RST packet firewall sending, in previous article, I talked about TTL, the TTL value your device receives from firewall system is much different with it from original server, for Linux system, we can fix it in kernel, when connection establishes, TTL value can record in socket structure, and if kernel receives RST, it can compare the TTL in RST with it in socket structure, which can tell whether this RST is send from original server, and I will come up later when it is done. &lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Conclusion&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;The usual methods firewall system used to block site accessing are IP filtering and keywords filtering. when we want to break through, the first thing is find a valid IP address, and second is avoid DNS query sending out, and use secure connection if server support, this technical I tested in Windows, Linux, I think IOS, too, just need to know how to configure it.&lt;/p&gt;

&lt;p&gt;Fix me if you find some wrong, and drop me email if you have questions.&lt;/p&gt;
</description>
        <pubDate>Fri, 03 Apr 2015 18:34:21 +0800</pubDate>
        <link>https://github.com/helloweishi//network/firewall/2015/04/03/access-youtube-without-vpn/</link>
        <guid isPermaLink="true">https://github.com/helloweishi//network/firewall/2015/04/03/access-youtube-without-vpn/</guid>
      </item>
    
      <item>
        <title>Visit Google inside firewall without VPN</title>
        <description>&lt;p&gt;I believe many people don&amp;rsquo;t like restrictions, we live in a equal world, we love freedom, but when you want to search something, you find you can&amp;rsquo;t even open that search engine&amp;rsquo;s main page, I believe you must feel bad, what&amp;rsquo;s going on there, it that a firewall system stuck your way ? &lt;/p&gt;

&lt;p&gt;So this article, I like to, from technical point of view, analysis how firewall works, why you request blocked, and how to break it.&lt;/p&gt;

&lt;p&gt;Here we go, for a firewall system, it will block your request if it know &lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;p&gt;it knows where you want to request and that destination is in black list&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;it knows what you want to request and it contains some sensitive information&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;&lt;strong&gt;For 1)&lt;/strong&gt;: when you type &amp;ldquo;www.google.com&amp;rdquo; in your browser, your PC/Phone will send DNS query to DNS server if your PC/Phone don&amp;rsquo;t have that domain&amp;rsquo;s IP address in DNS cache, or static configured, so one direct way to know where you want to request is check your DNS query, there are two way to block your request, &lt;/p&gt;

&lt;p&gt;option 1: Drop your DNS query, your DNS request can never reach DNS server;&lt;/p&gt;

&lt;p&gt;option 2: Reply you DNS query with wrong IP address, which is called DNS poison.&lt;/p&gt;

&lt;p&gt;In real appliance, blocking DNS query don&amp;rsquo;t block many requests, because DNS query can never reach firewall, all DNS servers we use by default are inside local ISP, normally, several routers away from your PC/Phone, so your DNS query can never go that far to firewall system, and you can try to configure your device&amp;rsquo;s DNS server to a foreign server, and check if firewall system will block your DNS query, or not.
normally, your device will get some valid IP addresses, and then, your device will send an SYN packet to IP address, which is Google server, and now, firewall system start to work, because there is no server inside, all the rest requests will go through firewall system, so here, it can drop your request directly for any requests to that Google server&amp;rsquo;s IP address, that is why you open your browser, type  &amp;ldquo;www.google.com&amp;rdquo;, and wait for a long time, and then, your browser display connection timeout.&lt;/p&gt;

&lt;p&gt;How firewall system know Google server&amp;rsquo;s IP address? especially, it is not just one, but many, it can know part of it, there are several ways to know that, one way is the corporation of ISP, ISP define a small IP pool of Google domain as DNS replying, firewall system can only block all IP in this pool, it can block all requests inside; another way is we can know who some public IP belong to via whois utility, for big company, it usually have a large IP pool, which we can find out via whois online. So for firewall system, it can not block that small IP pool ISP defined, it need more, and actually, it does. but it can not know all of them, and this will leave some space to us.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;For 2)&lt;/strong&gt;: In some period, you find you can open Google&amp;rsquo;s main page, but when you type some search keywords, your browser display connection reset immediately, that is another filter system, it not only check your request destination, but also check your request content, which do via pattern matching. normally, when you request Google service, your device will connect service port 80, which is HTTP request, it is plain text connection, everything you request can be seen by the router of routine, and every time you want to search something, its keywords you typed contain in type GET/POST kind of HTTP packets, firewall system can only check this two kind of packets, it will know what you want to request, and block it if sensitive, actually it is not forbid your request pass through, but send a RST packet to you device actively, which will make the connection between your device and Google server broken.&lt;/p&gt;

&lt;p&gt;Why firewall system don&amp;rsquo;t just drop you request packet, which will make your request never arrive Google server, and which you may think it is the simplest way, it will effect network throughput seriously if it does in this way, why? that is due to the design of network mode, it have 7 layers, but in real application, we just consider about 5 layers, which is physical layer, data link layer, network layer, transport layer, application layer from bottom up, IP information is contained in network layer, HTTP content is contained in application layer, for a router in the routine between your device and Google server, if it want to know what your request are, it have decode packets from your device bottom up, layer by layer, less layer it decode, faster packets can pass through, assume the time it take is the same each layer it decode, and it takes 1 second to forward one packet when it just decode one layer, if it decode two layer, it has to take 2 second, and etc, HTTP content is contained in application layer, can you image that ? it will be nightmare. Usually, router just need to decode three layers when forward, that means it just need to know where your request go, don&amp;rsquo;t care what your request are, for some network, they just decode two layers for throughput speed up, like using route protocol MPLS, it also called MPLS network. &lt;/p&gt;

&lt;p&gt;So for keywords filter system, I guess your HTTP request don&amp;rsquo;t pass through firewall directly, firewall is connected at the router, which forward your request packets to outside internet, when your request packets pass through, it will forward twice, one to outside internet, one to firewall, packet forward is pretty fast, it just sacrifice performance a little, or not at all. firewall will decode packets bottom up till application layer, if it find some sensitive keywords, RST packet will be sent to your device, connection broken. We can verify it, first, make sure you don&amp;rsquo;t surf internet via proxy, and then, capture packets when you search some sensitive keywords, from the packets your captured, you can see the time interval between your request packet and RST reply packet is much less than the interval between two continuous packets when connection establish, and after RST packet, Google server&amp;rsquo;s search reply packet arrive, too, and we can check TTL value in IP header, you can find TTL value in RST packet is much different from other packets from Google server. TTL means time to live, when one packet send from a device, it have a initial value, which usually is 128, or 255, every time this packet pass through a device, its value will decrease 1, if its value reach 0, this packet will be drop silently, from TTL value, you can how far it is your device from Google server,  and you can know how far firewall from your device. And the path go to and back from Google server may different, which depends on route protocols, TTL value may have a little difference from time to time, but usually the difference can&amp;rsquo;t reach more than 3 roughly, except the whole internet fluctuate a lot, that seems never happens so far, if it does, it will be a big news.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/ttl.png&quot; alt=&quot;TTL&quot;&gt;&lt;br&gt;
&lt;center&gt;&lt;small&gt;Figure 1:Time to live snapshot&lt;/small&gt;&lt;/center&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Time to break restriction&lt;/strong&gt;:&lt;/p&gt;

&lt;p&gt;From analysis above, I think you already know how firewall system work, so now, we start to break it.&lt;/p&gt;

&lt;p&gt;Break restriction 1:&lt;/p&gt;

&lt;p&gt;Remember I mentioned above, for a big company like Google, it has a large IP pool, if you try to get Google&amp;rsquo;s IP address via DNS query inside firewall system, it must fail, all the IP addresses you get inside are blocked directly, they are already listed in black list. &lt;/p&gt;

&lt;p&gt;One way to get a valid Google server IP address is try to get it from outside DNS servers, like some DNS servers in some country outside firewall system, you know Google have many servers in different countries, that can help user in different country getting better experience, and DNS server will return DNS request with Google server&amp;rsquo;s IP address in its own country first, maybe you will ask how can we get IP address from outside DNS servers, there are some online ping website, some ping website can ping the domain name you specified, like Google.com, from different countries at the same time, and return some valid IP address to you if ping that domain name succeed, normally, these IP addresses are different, after you get these IP address, you can just input these IP addresses in your browser one by one, if you are lucky, Google search page will show on the screen. Google search page are the default page if you just input IP address in browser, for now, you can just use Google&amp;rsquo;s search service, other services like maps, Gmail, youtube, and etc, you still can&amp;rsquo;t use, which I will talk about it in later article.&lt;/p&gt;

&lt;p&gt;Another way to search some valid Google server IP addresses is iterate Google&amp;rsquo;s IP pool, but you need more advanced skills, whois utility can be use to search Google&amp;rsquo;s IP pool, and there are some whois websites you can search at, IP pools is very large, it is pretty hard to ping them by hand,  one by one. There are many packets generator tools online, which can construct ping packets, it can iterate the whole IP pool in short time, after checking IP address ping succeed, you can get some valid IP addresses, or you can write a script via python, shell, and etc, and check the ping successful IP addresses.&lt;/p&gt;

&lt;p&gt;Break restriction 2:&lt;/p&gt;

&lt;p&gt;For keyword filter system, it can work, that is because the connection between your device and Google server is not encrypted, anyone in the middle can see it, you should use a secure one, which is HTTPS connection, when you open Google website, try to input https://www.google.com, instead of www.google.com, or just google.com.&lt;/p&gt;

&lt;p&gt;Access Google via HTTPS, all the context between your device and Google server are encrypted, there is no way to decrypted them in the middle, even firewall system can get, but it has no way to know what it is.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/google.png&quot; alt=&quot;google&quot;&gt;&lt;br&gt;
&lt;center&gt;&lt;small&gt;Figure 2:google search snapshot&lt;/small&gt;&lt;/center&gt;&lt;/p&gt;

&lt;p&gt;Ok, time to stop, if any questions, you can drop me a email, next article I will talk about how to visit youtube inside firewall system.&lt;br&gt;
Fix me, if you find some errors in my post.&lt;/p&gt;
</description>
        <pubDate>Mon, 02 Mar 2015 20:20:18 +0800</pubDate>
        <link>https://github.com/helloweishi//network/firewall/2015/03/02/access-google-without-vpn/</link>
        <guid isPermaLink="true">https://github.com/helloweishi//network/firewall/2015/03/02/access-google-without-vpn/</guid>
      </item>
    
  </channel>
</rss>
